name: "Terraform CD - apply"

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      # AWS認証情報とTerraformバックエンド設定を環境変数として定義
      AWS_REGION: "ap-northeast-1"
      TF_VERSION: "1.12.2"

    steps:
      # リポジトリのコードをチェックアウト
      - name: Checkout
        uses: actions/checkout@v4

      # no_terraformファイルの存在チェック
      - name: Check No Terraform File
        id: check_no_terraform
        uses: ./.github/actions/check-no-terraform

      # 共通処理をComposite Actionで実行
      - name: Setup Terraform Environment
        id: setup
        if: steps.check_no_terraform.outputs.no-terraform-found == 'false'
        uses: ./.github/actions/setup
        with:
          aws-iam-role: ${{ secrets.AWS_IAM_ROLE }}
          aws-tf-state-bucket: ${{ secrets.AWS_TF_STATE_BUCKET }}
          gh-dc-usermap: ${{ secrets.GH_DC_USERMAP }}
          aws-region: ${{ env.AWS_REGION }}
          tf-version: ${{ env.TF_VERSION }}

      # no_terraformファイル存在時のスキップ通知
      - name: Skip Terraform Apply
        if: steps.check_no_terraform.outputs.no-terraform-found == 'true'
        run: |
          echo "⚠️ Terraform Apply がスキップされました"
          echo "理由: ${{ steps.check_no_terraform.outputs.no-terraform-file }} ファイルが存在します"
          echo "Apply を有効にするには、このファイルを削除してください。"

      # Terraformの適用（no_terraformファイルが存在しない場合のみ）
      - name: Terraform Apply
        if: steps.check_no_terraform.outputs.no-terraform-found == 'false'
        working-directory: terraform
        run: terraform apply -auto-approve -input=false

      # Discord通知をComposite Actionで実行（no_terraformファイルが存在しない場合のみ）
      - name: Send Discord Notification
        if: ${{ always() && steps.check_no_terraform.outputs.no-terraform-found == 'false' }}
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ secrets.DC_WEBHOOK_GHAC }}
          job-status: ${{ job.status }}
          mention-id: ${{ steps.setup.outputs.discord-id }}
          title: "terraform apply"
