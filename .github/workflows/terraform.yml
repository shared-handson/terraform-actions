name: "Terraform CI/CD"

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’å®šç¾©
on:
  push:
    branches:
      - main # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚
  pull_request:
    branches:
      - main # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pull_requestæ™‚

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write

jobs:
  terraform:
    name: "Terraform"
    runs-on: ubuntu-latest

    env:
      # AWSèªè¨¼æƒ…å ±ã¨Terraformãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®šç¾©
      AWS_REGION: "ap-northeast-1"
      TF_VERSION: "1.12.2"

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªåã ã‘ã‚’å–å¾—
      - name: Get repository name without owner
        id: repo_name
        run: echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> "$GITHUB_ENV"

      # 2. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout
        uses: actions/checkout@v4

      # 3. AWSã®OIDCèªè¨¼ã‚’è¨­å®š
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      # 4. Terraform CLIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # 5. Terraformã®åˆæœŸåŒ–
      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.AWS_TF_STATE_BUCKET }}" \
            -backend-config="key=${REPO_NAME}/terraform.tfstate" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="use_lockfile=true"

      # 6. Terraformã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      # 7-1. (PRæ™‚)Terraformã®ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
      - name: Terraform Plan for PR
        id: plan-for-pr
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: |
          {
            echo 'PLAN_OUTPUT<<EOF'
            terraform plan -no-color -input=false
            echo EOF
          } >> "$GITHUB_ENV"

      # 7-2. (PRæ™‚)Pull Requestã«Plançµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: PR comment with Plan
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆã®æœ¬æ–‡ã‚’ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å¤‰æ•°ã«æ ¼ç´
          COMMENT_BODY=$(cat <<EOF
          #### Terraform Format and Style ğŸ–Œï¸ \`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization âš™ï¸ \`${{ steps.init.outcome }}\`
          #### Terraform Plan ğŸ“– \`${{ steps.plan-for-pr.outcome }}\`
          <details><summary>Show Plan</summary>

          \`\`\`terraform
          ${PLAN_OUTPUT}
          \`\`\`

          </details>

          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
          EOF
          )

          # Github CLIã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment --body-file <(echo "$COMMENT_BODY")

      # 8-1. (Pushæ™‚)Terraformã®ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãŠã‚ˆã³å‡ºåŠ›
      - name: Terraform Plan for Push
        id: plan-for-apply
        if: github.event_name == 'push'
        run: terraform plan -no-color -input=false -out=tfplan-for-push

      # 8-2. (Pushæ™‚)Terraformã®é©ç”¨
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false tfplan-for-push
