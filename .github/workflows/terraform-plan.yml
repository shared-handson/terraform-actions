name: "Terraform CI - plan"

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    env:
      # AWSèªè¨¼æƒ…å ±ã¨Terraformãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®šç¾©
      AWS_REGION: "ap-northeast-1"
      TF_VERSION: "1.12.2"

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout
        uses: actions/checkout@v4

      # tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼†å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      - name: Check TFVARS File
        id: check_tfvars
        run: |
          TFVARS_FILE=""
          if [ -n "$(find ./terraform -maxdepth 1 -iname "*.tfvars" -type f)" ]; then
            TFVARS_FILE=$(find ./terraform -maxdepth 1 -iname "*.tfvars" -type f | head -1)
            echo "Found tfvars file: ${TFVARS_FILE}"
            MSG_FILE=$(mktemp)
            echo "âŒ **tfvarså­˜åœ¨ç¢ºèª : å¤±æ•—**" > ${MSG_FILE}
            echo "âš ï¸ ã“ã®PRã¯ç¾åœ¨ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š" >> ${MSG_FILE}
            echo "" >> ${MSG_FILE}
            echo "### ğŸ”§ è©³ç´°" >> ${MSG_FILE}
            echo "\`${TFVARS_FILE}\` ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚" >> ${MSG_FILE}
          fi
          echo "MSG_FILE=${MSG_FILE}" >> "$GITHUB_OUTPUT"

      # (tfvarsãŒå­˜åœ¨ã—ã¦ã„ãŸæ™‚) Pull Request ã‚³ãƒ¡ãƒ³ãƒˆã«çµæœã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º
      - name: Handle tfvars Check Failure
        if: steps.check_tfvars.outputs.MSG_FILE != ''
        uses: ./.github/actions/pr-failure-handler
        with:
          message-file: ${{ steps.check_tfvars.outputs.MSG_FILE }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # å…±é€šå‡¦ç†ã‚’Composite Actionã§å®Ÿè¡Œ
      - name: Setup Terraform Environment
        id: setup
        uses: ./.github/actions/setup
        with:
          aws-iam-role: ${{ secrets.AWS_IAM_ROLE }}
          aws-tf-state-bucket: ${{ secrets.AWS_TF_STATE_BUCKET }}
          gh-dc-usermap: ${{ secrets.GH_DC_USERMAP }}
          tf-vars: ${{ secrets.TF_VARS }}
          aws-region: ${{ env.AWS_REGION }}
          tf-version: ${{ env.TF_VERSION }}

      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰S3ã®è¨­å®šã‚’ç¢ºèª
      - name: Check Backend
        id: check_backend
        continue-on-error: true
        working-directory: terraform
        run: |
          aws s3api head-bucket --bucket ${{ secrets.AWS_TF_STATE_BUCKET }}
          if [ ! -f ".terraform/terraform.tfstate" ]; then exit 1; fi
          if [ "$(jq -r '.backend.type' ".terraform/terraform.tfstate")" != "s3" ]; then exit 1; fi

      # (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚) Pull Request ã‚³ãƒ¡ãƒ³ãƒˆã«çµæœã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º
      - name: Handle Backend Check Failure
        if: steps.check_backend.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEMP_FILE=$(mktemp)
          cat << "EOF" > ${TEMP_FILE}
          âŒ **S3ç¢ºèª : å¤±æ•—**
          âš ï¸ ã“ã®PRã¯ç¾åœ¨ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ### ğŸ”§ è©³ç´°
          ä»¥ä¸‹ã®ã©ã‚Œã‹ãŒåŸå› ã®å¯èƒ½æ€§ãŒé«˜ã„
          - S3ã¸æ›¸ãè¾¼ã¿ãŒã§ããªã„
          - S3ãŒå­˜åœ¨ã—ãªã„

          ### ğŸ”§ ä¿®æ­£å¾Œã®å¯¾å¿œ
          1. ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å®Œäº†å¾Œã€æ–°ã—ã„PRã‚’ä½œæˆã—ã¦ãã ã•ã„
          3. ã¾ãŸã¯ã€ã“ã®PRã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ä¿®æ­£ã‚’pushã—ã¦ãã ã•ã„

          **10ç§’å¾Œã«PRã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™**
          EOF
          gh pr comment ${{ github.event.pull_request.number }} --body-file ${TEMP_FILE}
          rm -rf ${TEMP_FILE}
          sleep 10
          gh pr comment ${{ github.event.pull_request.number }} --body "ğŸš« **PRè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚**"
          gh pr close ${{ github.event.pull_request.number }}
          exit 1

      # Terraformã®ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
      - name: Terraform Plan for PR
        id: plan
        continue-on-error: true
        working-directory: terraform
        run: |
          set +e
          OUTPUT=$(terraform plan -no-color -input=false 2>&1)
          PLAN_EXIT_CODE=$?
          {
            echo 'PLAN_OUTPUT<<EOF'
            echo "$OUTPUT"
            echo EOF
          } >> "$GITHUB_OUTPUT"
          exit $PLAN_EXIT_CODE

      # (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚) Pull Request ã‚³ãƒ¡ãƒ³ãƒˆã«çµæœã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º
      - name: Handle Terraform Plan Failure
        if: steps.plan.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEMP_FILE=$(mktemp)
          cat << "EOF" > ${TEMP_FILE}
          âŒ **terraform plan : å¤±æ•—**
          âš ï¸ ã“ã®PRã¯ç¾åœ¨ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ### ğŸ”§ è©³ç´°
          <details>
          <summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ã</summary>

          ```terraform
          ${{ steps.plan.outputs.PLAN_OUTPUT }}
          ```

          </details>

          ### ğŸ”§ ä¿®æ­£å¾Œã®å¯¾å¿œ
          1. ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å®Œäº†å¾Œã€æ–°ã—ã„PRã‚’ä½œæˆã—ã¦ãã ã•ã„
          3. ã¾ãŸã¯ã€ã“ã®PRã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ä¿®æ­£ã‚’pushã—ã¦ãã ã•ã„

          **10ç§’å¾Œã«PRã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™**
          EOF
          gh pr comment ${{ github.event.pull_request.number }} --body-file ${TEMP_FILE}
          rm -rf ${TEMP_FILE}
          sleep 10
          gh pr comment ${{ github.event.pull_request.number }} --body "ğŸš« **PRè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚**"
          gh pr close ${{ github.event.pull_request.number }}
          exit 1

      # (æˆåŠŸæ™‚) Pull Request ã‚³ãƒ¡ãƒ³ãƒˆã«çµæœ
      - name: PR Comment on Success
        if: steps.plan.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEMP_FILE=$(mktemp)
          cat << "EOF" > ${TEMP_FILE}
          ğŸ‘ **terraform plan : æˆåŠŸ**
          âœ… æ­£ã—ãé©ç”¨ãŒå¯èƒ½ã§ã™ã€‚å†…å®¹ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          ### ğŸ”§ è©³ç´°
          <details>
          <summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ã</summary>

          ```terraform
          ${{ steps.plan.outputs.PLAN_OUTPUT }}
          ```

          </details>
          EOF
          gh pr comment ${{ github.event.pull_request.number }} --body-file ${TEMP_FILE}
          rm -rf ${TEMP_FILE}

      # no_terraformãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
      - name: Check No Terraform File
        id: check_no_terraform
        if: steps.plan.outcome == 'success'
        uses: ./.github/actions/check-no-terraform

      # (no_terraformãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨æ™‚) Applyç„¡åŠ¹åŒ–ã®è­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆ
      - name: PR Comment on No Terraform Warning
        if: steps.plan.outcome == 'success' && steps.check_no_terraform.outputs.no-terraform-found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEMP_FILE=$(mktemp)
          cat << "EOF" > ${TEMP_FILE}
          âš ï¸ **Terraform Apply ç„¡åŠ¹åŒ–**
          ğŸš« `${{ steps.check_no_terraform.outputs.no-terraform-file }}` ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
          ã“ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã¦ã‚‚ **Terraform apply ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“**ã€‚
          Apply ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
          EOF
          gh pr comment ${{ github.event.pull_request.number }} --body-file ${TEMP_FILE}
          rm -rf ${TEMP_FILE}
